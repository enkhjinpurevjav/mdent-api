version: "3.9"

networks:
  default:
    external: true
    name: mdent-core_mdent_net  # your existing network

services:
  mdent_api:
    image: node:20
  
    working_dir: /app
    environment:
      NODE_ENV: production
      # You said you want mdent_test:
      DATABASE_URL: postgresql://mdent:Monfamily2025@mdent_postgres:5432/mdent_test?schema=public
      PORT: 3000
    volumes:
      - /opt/mdent-api:/app   # use the code that already works on your server
    ports:
      - "8082:3000"
    command: >
      sh -lc "
        npm config set fund false audit false &&
        ( npm install --legacy-peer-deps --omit=optional || npm install --legacy-peer-deps --force ) &&
        npx prisma generate &&
        node server.js
      "
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:3000/"]
      interval: 20s
      timeout: 5s
      retries: 10
